name: Build WebGlass cross-platform

on:
  push:
    branches: [ main ]
    # avoid retrigger when workflow commits artifacts
    paths-ignore:
      - 'Windows/**'
      - 'Linux/**'

jobs:
  build-windows:
    name: Build Windows installer
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build Windows installer
        run: npm run dist:win

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: webglass-windows
          path: dist/*.exe

      - name: Commit installer into repo
        run: |
          mkdir -p Windows
          cp dist/*.exe Windows/ || echo "no exe found"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Windows/*.exe || echo "nothing to add"
          git commit -m "chore(ci): add Windows installer [skip ci]" || echo "no changes to commit"
          git push origin HEAD:main || echo "push failed"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: Build Linux AppImage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build Linux AppImage
        run: npm run dist:linux

      - name: Upload appimage artifact
        uses: actions/upload-artifact@v4
        with:
          name: webglass-linux
          path: dist/*.AppImage

      - name: Commit AppImage into repo
        run: |
          mkdir -p Linux
          cp dist/*.AppImage Linux/ || echo "no appimage found"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Linux/*.AppImage || echo "nothing to add"
          git commit -m "chore(ci): add Linux AppImage [skip ci]" || echo "no changes to commit"
          git push origin HEAD:main || echo "push failed"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
